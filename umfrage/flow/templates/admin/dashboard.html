{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="text-info">Admin Dashboard</h3>
    <div>
      <a href="/admin/export.csv" class="btn btn-outline-light btn-sm">Export CSV</a>
      <a href="/admin/export.json" class="btn btn-outline-light btn-sm">Export JSON</a>
      <a href="{{ url_for('admin_logout') }}" class="btn btn-danger btn-sm">Logout</a>
    </div>
  </div>

  <div class="card p-3 mb-4">
    <div><strong>Teilnehmer (Anzahl):</strong> {{ n }}</div>
    <div><strong>Durchschnittlicher Flow-Score:</strong> {{ avg_flow if avg_flow is not none else '-' }}</div>
  </div>

  <h5>Letzte Antworten</h5>
  <div class="table-responsive">
    <table class="table table-dark table-striped">
      <thead>
        <tr>
          <th>ID</th><th>Teilnehmer-ID</th><th>Zeit</th><th>Aktivität</th><th>Flow</th><th>WHO5_pre</th><th>WHO5_post</th><th>Δ</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r['id'] }}</td>
          <td>{{ r['participant_id'] if 'participant_id' in r.keys() else '-' }}</td>
          <td>{{ r['created_at'] }}</td>
          <td>{{ r['activity'] }}</td>
          <td>{{ r['flow_score'] }}</td>
          <td>{{ r['who5_pre_x4'] }}</td>
          <td>{{ r['who5_post_x4'] }}</td>
          <td>{{ r['delta_who5'] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <h5 class="mt-4">Consent-Logs</h5>
  <div class="table-responsive">
    <table class="table table-dark table-striped">
      <thead><tr><th>ID</th><th>Zeit</th><th>Version</th><th>Agreed</th><th>User-Agent</th></tr></thead>
      <tbody>
        {% for c in cons %}
        <tr>
          <td>{{ c['id'] }}</td>
          <td>{{ c['created_at'] }}</td>
          <td>{{ c['consent_version'] }}</td>
          <td>{{ 'ja' if c['agreed'] else 'nein' }}</td>
          <td style="max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{{ c['user_agent'] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
